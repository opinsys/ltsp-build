#!/bin/sh

set -eu

cleanup() {
  test -n "$xml_hostdefinition" && rm -f "$xml_hostdefinition"
}

macaddress() {
  echo "52:54:00:$(openssl rand -hex 3 | sed 's/\(..\)/\1:/g; s/.$//')"
}

trap cleanup EXIT

{
  set +u
  targethostname=$1
  diskimage=$2
}

if [ -z "$targethostname" -o -z "$diskimage" ]; then
  echo "Usage: $(basename $0) hostname diskimagepath" > /dev/stderr
  exit 1
fi

uuid=$(uuidgen)
mac_address_inet=$(macaddress)
mac_address_ltsp=$(macaddress)

tmpdiffimage=$(mktemp /tmp/$targethostname-XXXXXXXXXX)
qemu-img create -b $diskimage -f qcow2 $tmpdiffimage

xml_hostdefinition=$(mktemp /tmp/xml_hostdefinition.XXXXXXXXXX)

cat <<-EOF > $xml_hostdefinition
	<domain type='kvm'>
	  <name>$targethostname</name>
	  <uuid>$uuid</uuid>
	  <memory>2097152</memory>
	  <currentMemory>2097152</currentMemory>
	  <vcpu>1</vcpu>
	  <os>
	    <type arch='x86_64' machine='pc-1.0'>hvm</type>
	    <boot dev='hd'/>
	  </os>
	  <features>
	    <acpi/>
	  </features>
	  <clock offset='utc'/>
	  <on_poweroff>destroy</on_poweroff>
	  <on_reboot>restart</on_reboot>
	  <on_crash>destroy</on_crash>
	  <devices>
	    <emulator>/usr/bin/kvm</emulator>
	    <disk type='file' device='disk'>
	      <driver name='qemu' type='qcow2'/>
	      <source file='$tmpdiffimage'/>
	      <target dev='hda' bus='ide'/>
	      <address type='drive' controller='0' bus='0' unit='0'/>
	    </disk>
	    <controller type='ide' index='0'>
	      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/>
	    </controller>
	    <interface type='bridge'>
	      <mac address='$mac_address_inet'/>
	      <source bridge='br0'/>
	      <model type='virtio'/>
	      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>
	    </interface>
	    <interface type='bridge'>
	      <mac address='$mac_address_ltsp'/>
	      <source bridge='br12'/>
	      <model type='virtio'/>
	      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>
	    </interface>
	    <serial type='pty'>
	      <target port='0'/>
	    </serial>
	    <console type='pty'>
	      <target type='serial' port='0'/>
	    </console>
	    <input type='mouse' bus='ps2'/>
	    <graphics type='vnc' port='-1' autoport='yes' listen='127.0.0.1'>
	      <listen type='address' address='127.0.0.1'/>
	    </graphics>
	    <video>
	      <model type='cirrus' vram='9216' heads='1'/>
	      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/>
	    </video>
	    <memballoon model='virtio'>
	      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>
	    </memballoon>
	  </devices>
	</domain>
	EOF

sudo virsh define $xml_hostdefinition

echo "run: sudo virsh start $targethostname --console --autodestroy"
